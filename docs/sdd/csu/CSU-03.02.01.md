# CSU-03.02.01: 셸 명령어 실행

## 1. CSU 간단 설명

`tools/shell.ts`에 위치한 이 CSU는 모델(LLM)이 운영체제의 셸 명령어를 실행할 수 있도록 하는 `run_shell_command` 도구를 구현합니다. 이 도구는 에이전트에게 가장 강력한 권한을 부여하는 만큼, 여러 단계의 정교한 보안 장치와 사용자 제어 기능을 통해 안전한 실행을 보장하는 데 중점을 둡니다.

주요 기능으로는 ▲실행 전 위험 명령어 필터링, ▲사용자에게 실행 권한을 명시적으로 확인받는 절차, ▲실행 중인 명령어의 출력을 실시간으로 스트리밍하는 기능, ▲OS(Windows/Unix-like)에 따른 실행 방식 분기 등이 포함됩니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명              | 설명                                                                                   |
| --------------------- | -------------------------------------------------------------------------------------- |
| `ShellTool`           | `run_shell_command` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다.  |
| `ShellToolInvocation` | `run_shell_command` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다. |

## 3. 각 클래스에 대한 입출력 및 함수 처리 설명

### 3.1 `ShellTool` 클래스

- **역할**: 모델에게 `run_shell_command` 도구의 사용법과 제약 사항을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`run_shell_command`), OS별 상세 설명, 그리고 파라미터(`command`, `description`, `directory`)의 JSON 스키마를 설정합니다.
  - **`validateToolParamValues(params)`**: 모델이 전달한 파라미터의 유효성과 안전성을 검증하는 핵심 보안 메서드입니다.
    - `isCommandAllowed()`를 호출하여 `$(...)`와 같은 명령어 치환이나 기타 위험할 수 있는 패턴이 명령어에 포함되었는지 확인하고 차단합니다.
    - `directory` 파라미터가 지정된 경우, 해당 경로가 허용된 작업 공간(workspace) 내에 있는지 확인하여 임의의 경로에서 명령어가 실행되는 것을 방지합니다.
    - `getCommandRoots()`를 통해 `git status | grep foo`와 같은 복합 명령어에서 `git`, `grep`과 같은 기본 명령어들을 추출하고, 추출된 명령어가 없으면 오류를 반환합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `ShellToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `ShellToolInvocation` 클래스

- **역할**: `run_shell_command` 도구의 한 번의 호출에 대한 실제 실행을 담당하며, 사용자 확인 및 프로세스 실행의 전 과정을 관리합니다.

#### `shouldConfirmExecute()` 메서드

- **역할**: `execute()`가 호출되기 전, 사용자에게 명령어 실행을 허용할지 확인하는 보안 게이트 역할을 합니다.
- **함수 처리 설명**:
  1.  실행할 명령어에서 `git`, `npm` 등과 같은 루트(root) 명령어들을 추출합니다.
  2.  추출된 루트 명령어가 사용자가 이전에 "항상 허용"으로 승인한 `allowlist`에 있는지 확인합니다.
  3.  `allowlist`에 없는 명령어가 하나라도 있으면, UI에 확인 다이얼로그를 띄우는 데 필요한 정보(`ToolExecuteConfirmationDetails` 객체)를 반환합니다. 이 객체에는 전체 명령어, 루트 명령어, 그리고 사용자가 "항상 허용"을 선택했을 때 `allowlist`에 해당 명령어를 추가하는 콜백 함수가 포함됩니다.
  4.  모든 명령어가 `allowlist`에 있으면, 확인 절차를 건너뛰고 `false`를 반환합니다.

#### `execute()` 메서드

- **역할**: (사용자 확인 후) 실제 셸 명령어를 자식 프로세스로 실행하고 그 결과를 처리합니다.
- **함수 처리 설명**:
  1.  **실행 위임**: 실제 프로세스 실행은 `ShellExecutionService.execute()`에 위임합니다. 이 서비스는 `node-pty` 사용 여부 등 설정에 따라 최적의 방식으로 자식 프로세스를 생성하고 관리합니다.
  2.  **실시간 출력 스트리밍**: `ShellExecutionService`에 콜백 함수를 전달하여, 자식 프로세스의 `stdout` 출력을 실시간으로 이벤트로 수신합니다. 수신된 데이터는 `updateOutput` 콜백을 통해 즉시 UI로 전달되어 사용자가 명령어 실행 과정을 볼 수 있게 합니다.
  3.  **프로세스 결과 수집**: 명령어 실행이 완료되면, `ShellExecutionService`로부터 최종 결과(`output`, `error`, `exitCode`, `signal`, `pid` 등)를 받습니다.
  4.  **결과 포맷팅**: 수집된 모든 결과를 종합하여, 모델이 분석할 상세한 형식의 `llmContent`와 UI에 표시될 간결한 `returnDisplay` 메시지를 생성합니다.
  5.  **결과 반환**: 최종적으로 포맷팅된 내용을 담은 `ToolResult` 객체를 반환합니다. 만약 출력이 너무 길 경우, LLM을 통해 요약하는 로직도 포함될 수 있습니다.

## 4. 기타 참고사항

- **`ShellExecutionService`**: 실제 프로세스를 생성하고 스트림을 처리하는 복잡한 로직은 별도의 `ShellExecutionService`에 위임되어 있습니다. 이를 통해 `ShellToolInvocation`은 비즈니스 로직과 사용자 확인 흐름에 더 집중할 수 있습니다.
- **`node-pty`**: 설정에서 `enableInteractiveShell`이 활성화된 경우, `node-pty`를 사용하여 실제 터미널과 유사한 환경(pseudo-terminal)에서 명령어를 실행합니다. 이는 `stdin`을 통한 상호작용이 필요한 명령어(예: `vim`)를 지원하기 위함입니다.
- **보안 최우선**: 이 도구는 모델에게 강력한 기능을 제공하는 만큼, 여러 단계의 검증과 명시적인 사용자 동의 없이는 절대 실행되지 않도록 설계되었습니다.

# CSU-03.01.02: 파일 읽기

## 1. CSU 간단 설명

`tools/read-file.ts`에 위치한 이 CSU는 모델(LLM)이 로컬 파일 시스템의 특정 파일 내용을 읽을 수 있도록 하는 `read_file` 도구를 구현합니다. 이 도구는 텍스트 파일뿐만 아니라 이미지(PNG, JPG 등)와 PDF 파일도 처리할 수 있습니다.

특히, 대용량 텍스트 파일의 경우 `offset`과 `limit` 파라미터를 통해 특정 줄 범위만 읽어오는 페이지네이션(pagination) 기능을 지원하며, 파일 내용이 잘렸을 경우 모델에게 다음 부분을 읽는 방법을 안내하는 친절한 메시지를 제공합니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명                 | 설명                                                                                                                |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------- |
| `ReadFileTool`           | `read_file` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다. `BaseDeclarativeTool`을 상속받습니다. |
| `ReadFileToolInvocation` | `read_file` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다. `BaseToolInvocation`을 상속받습니다. |

### 주요 인터페이스

| 인터페이스명         | 설명                                                                             |
| -------------------- | -------------------------------------------------------------------------------- |
| `ReadFileToolParams` | 이 도구가 받는 파라미터(`absolute_path`, `offset`, `limit`)의 구조를 정의합니다. |

## 3. 각 클래스에 대한 입출력 및 함수 처리 설명

### 3.1 `ReadFileTool` 클래스

- **역할**: 모델에게 `read_file` 도구의 사용법을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`read_file`), 설명, 그리고 모델이 호출 시 사용해야 할 파라미터의 JSON 스키마를 설정합니다. 파라미터는 다음과 같습니다:
    - `absolute_path`: (필수) 읽을 파일의 절대 경로.
    - `offset`: (선택) 읽기 시작할 줄 번호 (0-based).
    - `limit`: (선택) 읽어올 최대 줄 수.
  - **`validateToolParamValues(params)`**: 모델이 전달한 파라미터의 유효성을 검증하는 보안 핵심 메서드입니다.
    - `absolute_path`가 비어있지 않은 절대 경로인지 확인합니다.
    - `absolute_path`가 허용된 작업 공간(workspace) 또는 프로젝트 임시 디렉터리 내에 있는지 확인하여, 모델이 임의의 시스템 파일에 접근하는 것을 방지합니다.
    - `offset`과 `limit` 값이 유효한 숫자인지 확인합니다.
    - 파일 경로가 `.geminiignore` 패턴에 의해 무시되는 대상인지 확인합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `ReadFileToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `ReadFileToolInvocation` 클래스

- **역할**: `read_file` 도구의 한 번의 호출에 대한 실제 실행을 담당합니다.

#### `execute()` 메서드

- **입력**: 없음 (필요한 파라미터는 생성자에서 `this.params`로 전달받음)
- **출력**: `Promise<ToolResult>` (모델이 이해할 내용과 UI에 표시될 내용을 포함한 결과 객체)
- **함수 처리 설명**:
  1.  **파일 처리 위임**: 실제 파일 읽기 로직은 `processSingleFileContent` 유틸리티 함수에 위임합니다. 이 함수는 파일 종류(텍스트, 이미지 등)를 감지하고, `offset`과 `limit`을 적용하여 파일 내용을 처리한 후, 그 결과를 반환합니다.
  2.  **오류 처리**: `processSingleFileContent`가 반환한 결과에 오류가 포함되어 있으면, 즉시 오류를 담은 `ToolResult`를 반환합니다.
  3.  **페이지네이션 처리 (Truncation)**: 만약 결과가 `isTruncated: true`로 표시되면, 파일 내용이 일부만 반환되었음을 의미합니다. 이 경우, 모델에게 다음과 같은 정보를 포함한 안내 메시지를 `llmContent`로 생성합니다:
      - 내용이 잘렸다는 경고.
      - 현재 표시 중인 줄의 범위와 전체 줄 수 (예: "Showing lines 1-100 of 500 total lines.").
      - 다음 부분을 읽기 위해 `read_file`을 다시 호출할 때 사용해야 할 `offset` 값.
  4.  **원격 측정**: `logFileOperation`을 호출하여 파일 읽기 작업에 대한 원격 측정 데이터(읽은 줄 수, 파일 타입 등)를 기록합니다.
  5.  **결과 반환**: 최종적으로 `llmContent`(전체 파일 내용 또는 페이지네이션 안내 메시지)와 `returnDisplay`(UI용 요약)를 포함한 `ToolResult` 객체를 반환합니다.

## 4. 기타 참고사항

- **대용량 파일 처리**: 이 도구의 핵심 기능 중 하나는 페이지네이션입니다. 모델은 `read_file`을 반복적으로 호출하면서 `offset` 값을 조정하여 아무리 큰 파일이라도 처음부터 끝까지 순차적으로 읽을 수 있습니다.
- **추상화**: 복잡한 파일 처리 로직(인코딩, 바이너리 데이터 처리 등)은 `processSingleFileContent` 유틸리티 함수에 추상화되어 있어, `ReadFileToolInvocation`은 결과 처리와 모델과의 상호작용에만 집중할 수 있습니다.

# CSU-03.01.01: 디렉토리 리스팅

## 1. CSU 간단 설명

`tools/ls.ts`에 위치한 이 CSU는 모델(LLM)이 로컬 파일 시스템의 특정 디렉터리에 있는 파일 및 하위 디렉터리 목록을 조회할 수 있도록 하는 `list_directory` 도구를 구현합니다. 이 도구는 단순한 디렉터리 나열을 넘어, `.gitignore`와 같은 무시(ignore) 파일을 존중하고, 지정된 작업 공간(workspace) 내에서만 작동하도록 하여 보안과 편의성을 모두 제공합니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명           | 설명                                                                                                                     |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------ |
| `LSTool`           | `list_directory` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다. `BaseDeclarativeTool`을 상속받습니다. |
| `LSToolInvocation` | `list_directory` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다. `BaseToolInvocation`을 상속받습니다. |

### 주요 인터페이스

| 인터페이스명   | 설명                                                              |
| -------------- | ----------------------------------------------------------------- |
| `LSToolParams` | 이 도구가 받는 파라미터(경로, 무시 패턴 등)의 구조를 정의합니다.  |
| `FileEntry`    | 도구가 반환하는 개별 파일 또는 디렉터리 정보의 구조를 정의합니다. |

## 3. 각 클래스에 대한 입출력 및 함수 처리 설명

### 3.1 `LSTool` 클래스

- **역할**: 모델에게 `list_directory` 도구의 사용법을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`list_directory`), 설명, 그리고 모델이 호출 시 사용해야 할 파라미터의 JSON 스키마를 설정합니다. 주요 파라미터는 다음과 같습니다:
    - `path`: (필수) 목록을 조회할 디렉터리의 절대 경로.
    - `ignore`: (선택) 결과를 필터링할 때 사용할 glob 패턴 배열.
    - `file_filtering_options`: (선택) `.gitignore` 또는 `.geminiignore` 파일 존중 여부.
  - **`validateToolParamValues(params)`**: 모델이 전달한 파라미터의 유효성을 검증합니다. 이 메서드는 보안에 매우 중요합니다.
    - `path`가 절대 경로인지 확인합니다.
    - `path`가 설정된 작업 공간(workspace) 디렉터리 내에 있는지 확인하여, 모델이 임의의 시스템 경로에 접근하는 것을 방지합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `LSToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `LSToolInvocation` 클래스

- **역할**: `list_directory` 도구의 한 번의 호출에 대한 실제 실행을 담당합니다.

#### `execute()` 메서드

- **입력**: 없음 (필요한 파라미터는 생성자에서 `this.params`로 전달받음)
- **출력**: `Promise<ToolResult>` (모델이 이해할 내용과 UI에 표시될 내용을 포함한 결과 객체)
- **함수 처리 설명**:
  1.  **경로 유효성 검사**: `fs.stat`을 사용하여 `this.params.path`가 실제로 존재하며 디렉터리인지 확인합니다. 아닐 경우, 오류를 담은 `ToolResult`를 반환합니다.
  2.  **디렉터리 읽기**: `fs.readdir`를 사용하여 디렉터리 내의 모든 파일과 하위 디렉터리 이름을 읽어옵니다.
  3.  **필터링**: `config.getFileService()`를 통해 `FileDiscoveryService`를 가져옵니다. 이 서비스를 사용하여 `.gitignore` 및 `.geminiignore` 파일의 규칙에 따라 목록을 필터링합니다. 또한, 사용자가 `ignore` 파라미터로 전달한 패턴도 적용하여 필터링합니다.
  4.  **정보 수집**: 필터링된 각 항목에 대해 다시 `fs.stat`을 호출하여 디렉터리 여부, 크기, 수정 시간 등의 상세 정보를 수집하여 `FileEntry` 객체 배열을 생성합니다.
  5.  **정렬**: 최종 목록을 디렉터리가 위로 오도록, 그리고 이름순으로 정렬합니다.
  6.  **결과 포맷팅**: 두 가지 형태의 결과 문자열을 생성합니다.
      - `llmContent`: 모델이 쉽게 파싱할 수 있도록 `[DIR]` 접두사 등을 포함하여 상세하게 포맷된 문자열입니다.
      - `returnDisplay`: UI에 간결하게 표시될 요약 정보입니다. (예: "Listed 5 item(s).")
  7.  생성된 두 문자열을 `ToolResult` 객체에 담아 반환합니다.

## 4. 기타 참고사항

- **보안**: 이 도구는 `validateToolParamValues`를 통해 모델이 허용된 작업 공간 외부의 파일 시스템에 접근하는 것을 원천적으로 차단합니다.
- **컨텍스트 인식**: 단순히 파일 목록만 반환하는 것이 아니라, 프로젝트의 `.gitignore` 설정을 이해하고 그에 따라 불필요한 파일(예: `node_modules`)을 결과에서 제외함으로써 더 유용한 컨텍스트를 모델에 제공합니다.

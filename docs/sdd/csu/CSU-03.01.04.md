# CSU-03.01.04: 파일 패턴 검색(Glob)

## 1. CSU 간단 설명

`tools/glob.ts`에 위치한 이 CSU는 모델(LLM)이 `src/**/*.ts`나 `**/*.md`와 같은 glob 패턴을 사용하여 파일 시스템에서 원하는 파일들을 효율적으로 검색할 수 있도록 하는 `glob` 도구를 구현합니다.

이 도구는 단순한 패턴 매칭을 넘어, 검색 결과를 **최근에 수정된 파일 우선**으로 정렬하여 모델에게 가장 관련성 높을 것으로 예상되는 파일을 먼저 제공하는 지능적인 기능을 포함하고 있습니다. 또한, `.gitignore` 파일을 존중하고 허용된 작업 공간(workspace) 내에서만 검색을 수행하여 컨텍스트에 맞는 안전한 검색을 보장합니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명             | 설명                                                                      |
| -------------------- | ------------------------------------------------------------------------- |
| `GlobTool`           | `glob` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다.  |
| `GlobToolInvocation` | `glob` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다. |

### 주요 함수

| 함수명            | 설명                                                                                      |
| ----------------- | ----------------------------------------------------------------------------------------- |
| `sortFileEntries` | 파일 목록을 정렬하는 헬퍼 함수. 최근 수정된 파일을 먼저, 그 외에는 이름순으로 정렬합니다. |

## 3. 각 클래스 및 함수에 대한 상세 설명

### 3.1 `GlobTool` 클래스

- **역할**: 모델에게 `glob` 도구의 사용법을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`glob`), 설명, 그리고 모델이 호출 시 사용해야 할 파라미터의 JSON 스키마를 설정합니다. 주요 파라미터는 다음과 같습니다:
    - `pattern`: (필수) 검색할 파일의 glob 패턴.
    - `path`: (선택) 검색을 시작할 디렉터리 경로.
    - `case_sensitive`, `respect_git_ignore` 등 검색 옵션.
  - **`validateToolParamValues(params)`**: 모델이 전달한 파라미터의 유효성을 검증합니다.
    - `pattern`이 비어있지 않은지 확인합니다.
    - `path`가 지정된 경우, 해당 경로가 허용된 작업 공간(workspace) 내에 있는지 확인하여 보안을 강화합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `GlobToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `GlobToolInvocation` 클래스

- **역할**: `glob` 도구의 한 번의 호출에 대한 실제 실행을 담당합니다.

#### `execute()` 메서드

- **입력**: 없음 (필요한 파라미터는 생성자에서 `this.params`로 전달받음)
- **출력**: `Promise<ToolResult>` (검색된 파일 목록을 포함한 결과 객체)
- **함수 처리 설명**:
  1.  **검색 디렉터리 결정**: `this.params.path`가 주어지면 해당 디렉터리에서, 주어지지 않으면 설정된 모든 작업 공간 디렉터리에서 검색을 수행합니다.
  2.  **Glob 실행**: 각 검색 디렉터리에서 `glob` 라이브러리를 사용하여 `this.params.pattern`과 일치하는 파일 목록을 찾습니다. 이때 `nodir: true`(디렉터리 제외), `stat: true`(파일 정보 포함) 등의 옵션을 사용합니다.
  3.  **결과 필터링**: `FileDiscoveryService`를 사용하여, 검색된 파일 목록에서 `.gitignore`와 `.geminiignore` 규칙에 따라 무시해야 할 파일들을 추가로 제외합니다.
  4.  **결과 정렬**: `sortFileEntries` 함수를 호출하여 필터링된 최종 파일 목록을 정렬합니다. 최근 24시간 내에 수정된 파일들이 가장 위에, 수정 시간 순서대로 정렬됩니다. 그 외의 파일들은 이름순으로 정렬됩니다.
  5.  **결과 포맷팅**: 모델이 사용할 `llmContent`(찾은 파일 개수, 무시된 파일 정보, 정렬된 전체 경로 목록 포함)와 UI에 표시될 `returnDisplay`(간단한 요약) 두 가지 형태의 결과 문자열을 생성하여 `ToolResult` 객체로 반환합니다.

### 3.3 `sortFileEntries` 함수

- **역할**: 파일 목록의 관련성을 높이기 위한 지능적인 정렬을 수행합니다.
- **함수 처리 설명**:
  - 두 파일의 수정 시간(`mtimeMs`)을 비교합니다.
  - 두 파일 모두 최근(예: 24시간 이내)에 수정되었다면, 더 새로운 파일이 앞으로 오도록 정렬합니다 (내림차순).
  - 하나만 최근 파일이라면, 최근 파일이 무조건 앞으로 오도록 정렬합니다.
  - 두 파일 모두 오래된 파일이라면, 경로 이름순(알파벳순)으로 정렬합니다.

## 4. 기타 참고사항

- **지능적 검색**: 이 도구는 단순히 파일을 찾는 것을 넘어, "최근에 작업한 파일일수록 더 관련성이 높을 것이다"라는 휴리스틱(heuristic)을 적용하여 모델이 더 효율적으로 필요한 정보를 찾을 수 있도록 돕습니다.
- **통합된 필터링**: `ls` 도구와 마찬가지로 `FileDiscoveryService`를 사용하여 파일 필터링을 수행함으로써, `.gitignore` 처리와 같은 컨텍스트 인식 동작이 모든 파일 관련 도구에서 일관되게 적용됩니다.

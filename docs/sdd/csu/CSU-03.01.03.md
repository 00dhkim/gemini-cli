# CSU-03.01.03: 파일 쓰기

## 1. CSU 간단 설명

`tools/write-file.ts`에 위치한 이 CSU는 모델(LLM)이 로컬 파일 시스템에 새로운 파일을 생성하거나 기존 파일의 내용을 덮어쓸 수 있도록 하는 `write_file` 도구를 구현합니다. 파일 쓰기는 매우 민감한 작업이므로, 이 도구는 여러 단계의 안전장치를 통해 안정성과 보안을 보장합니다.

주요 기능으로는 ▲경로 유효성 검사를 통한 보안 강화, ▲쓰기 전 LLM을 이용한 내용 자동 보정, ▲사용자에게 변경 사항(diff)을 명확히 보여주고 승인을 받는 확인 절차, ▲사용자가 직접 내용을 수정할 수 있는 기능 등이 포함됩니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명                  | 설명                                                                            |
| ------------------------- | ------------------------------------------------------------------------------- |
| `WriteFileTool`           | `write_file` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다.  |
| `WriteFileToolInvocation` | `write_file` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다. |

### 주요 함수

| 함수명                    | 설명                                                                                                   |
| ------------------------- | ------------------------------------------------------------------------------------------------------ |
| `getCorrectedFileContent` | 모델이 제안한 파일 내용을 쓰기 전에, 다른 LLM을 통해 문법 오류 등을 자동으로 보정하는 헬퍼 함수입니다. |

## 3. 각 구성요소에 대한 입출력 및 함수 처리 설명

### 3.1 `WriteFileTool` 클래스

- **역할**: 모델에게 `write_file` 도구의 사용법을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`write_file`), 설명, 그리고 파라미터(`file_path`, `content`)의 JSON 스키마를 설정합니다.
  - **`validateToolParamValues(params)`**: 모델이 전달한 파라미터의 유효성을 검증하는 보안 핵심 메서드입니다.
    - `file_path`가 절대 경로이며, 허용된 작업 공간(workspace) 내에 있는지 확인하여 임의의 시스템 파일에 쓰는 것을 방지합니다.
    - `file_path`가 디렉터리를 가리키는지 확인하여, 디렉터리를 덮어쓰는 실수를 방지합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `WriteFileToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `WriteFileToolInvocation` 클래스

- **역할**: `write_file` 도구의 한 번의 호출에 대한 실제 실행을 담당하며, 사용자 확인을 포함한 복잡한 실행 흐름을 관리합니다.

#### `shouldConfirmExecute()` 메서드

- **역할**: `execute()`가 호출되기 전, 사용자에게 실행 여부를 확인해야 하는지를 결정하고 확인에 필요한 정보를 생성합니다.
- **함수 처리 설명**:
  1.  `ApprovalMode`가 `AUTO_EDIT`이면, 확인 절차를 건너뛰고 `false`를 반환합니다.
  2.  `getCorrectedFileContent()`를 호출하여 원본 파일 내용과 모델이 제안한 (그리고 자동으로 보정된) 내용을 가져옵니다.
  3.  두 내용의 차이점을 보여주는 `diff` 패치를 생성합니다.
  4.  UI가 사용자 확인 다이얼로그를 렌더링하는 데 필요한 모든 정보(파일 경로, diff 내용, 콜백 함수 등)를 담은 `ToolEditConfirmationDetails` 객체를 반환합니다. 이 객체를 받은 UI는 사용자에게 변경점을 명확히 보여주고 승인을 요청합니다.

#### `execute()` 메서드

- **역할**: (사용자 확인 후) 실제 파일 쓰기 작업을 수행합니다.
- **함수 처리 설명**:
  1.  `getCorrectedFileContent()`를 다시 호출하여, 사용자 확인 과정에서 내용이 수정되었을 가능성까지 반영된 최종 파일 내용을 가져옵니다.
  2.  파일을 쓸 디렉터리가 존재하지 않으면 `fs.mkdirSync`로 재귀적으로 생성합니다.
  3.  `config.getFileSystemService().writeTextFile()`을 호출하여 최종 내용을 파일에 씁니다.
  4.  `logFileOperation`을 호출하여 파일 생성(`CREATE`) 또는 수정(`UPDATE`)에 대한 원격 측정 데이터를 기록합니다.
  5.  성공 메시지와 함께, 실제 변경 내용을 담은 `FileDiff` 객체를 `ToolResult`에 담아 반환합니다. UI는 이 정보를 바탕으로 작업 완료 후의 변경 사항을 사용자에게 보여줄 수 있습니다.

### 3.3 `getCorrectedFileContent()` 함수

- **역할**: 모델이 생성한 코드나 텍스트에 있을 수 있는 미묘한 오류를 줄여, 도구의 신뢰성을 높이는 LLM 기반 자동 보정 필터입니다.
- **함수 처리 설명**:
  - **기존 파일 수정 시**: `ensureCorrectEdit` 함수를 호출합니다. 이 함수는 원본 내용 전체를 `old_string`으로, 모델 제안 내용을 `new_string`으로 간주하여, 마치 `replace` 도구를 쓰듯 LLM에게 전체적인 일관성과 문법을 교정해달라고 요청합니다.
  - **새 파일 생성 시**: `ensureCorrectFileContent` 함수를 호출하여, LLM에게 새 파일의 내용 자체에 오류가 없는지 검토하고 수정해달라고 요청합니다.

## 4. 기타 참고사항

- **신뢰성 및 안정성**: 이 도구는 단순히 `fs.writeFile`을 호출하는 래퍼(wrapper)가 아닙니다. LLM의 결과물이 항상 완벽하지 않다는 가정 하에, 자동 보정과 사용자 확인이라는 2중, 3중의 안전장치를 통해 결과물의 품질과 시스템의 안정성을 극대화합니다.
- **사용자 경험(UX)**: `diff`를 통한 명확한 변경점 제시와 사용자가 직접 수정할 기회를 제공함으로써, 사용자가 에이전트의 작업을 신뢰하고 제어할 수 있도록 합니다.

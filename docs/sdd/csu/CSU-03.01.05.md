# CSU-03.01.05: 파일 수정(Edit)

## 1. CSU 간단 설명

`tools/edit.ts`에 위치한 이 CSU는 모델(LLM)이 파일의 특정 내용을 찾아 다른 내용으로 교체할 수 있도록 하는 `replace` 도구를 구현합니다. (`write_file` 도구가 파일 전체를 덮어쓰는 것과 달리) 이 도구는 `old_string`으로 지정된 부분을 정확히 찾아 `new_string`으로 대체하는, 보다 정밀하고 외과적인(surgical) 수정 작업을 수행합니다.

이 도구는 `write_file`과 마찬가지로 작업 공간(workspace) 경로 검증, LLM을 이용한 자동 보정, `diff`를 통한 사용자 확인 등 여러 단계의 강력한 안전장치를 포함하고 있습니다. 특히, 교체할 문자열의 발생 횟수(`occurrences`)를 정확히 제어하여 의도치 않은 변경을 방지하는 기능이 핵심입니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명             | 설명                                                                                                              |
| -------------------- | ----------------------------------------------------------------------------------------------------------------- |
| `EditTool`           | `replace` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다. `BaseDeclarativeTool`을 상속받습니다. |
| `EditToolInvocation` | `replace` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다.                                      |

### 주요 함수

| 함수명             | 설명                                                                     |
| ------------------ | ------------------------------------------------------------------------ |
| `applyReplacement` | 특수문자(`$`)를 안전하게 처리하며 문자열을 교체하는 유틸리티 함수입니다. |

## 3. 각 클래스에 대한 입출력 및 함수 처리 설명

### 3.1 `EditTool` 클래스

- **역할**: 모델에게 `replace` 도구의 사용법을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`replace`), 설명, 그리고 파라미터(`file_path`, `old_string`, `new_string`, `expected_replacements`)의 JSON 스키마를 설정합니다. 특히, `old_string`은 정확한 교체를 위해 여러 줄의 컨텍스트를 포함해야 한다는 매우 상세한 지침을 모델에게 제공합니다.
  - **`validateToolParamValues(params)`**: 모델이 전달한 파라미터의 유효성을 검증합니다. `file_path`가 절대 경로이며 허용된 작업 공간 내에 있는지 확인하여 보안을 강화합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `EditToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `EditToolInvocation` 클래스

- **역할**: `replace` 도구의 한 번의 호출에 대한 실제 실행을 담당하며, 실행 전 검증, 사용자 확인, 실제 실행의 복잡한 흐름을 관리합니다.

#### `calculateEdit()` (내부 헬퍼 메서드)

- **역할**: 실제 파일 시스템을 변경하기 전에, 수정 작업의 결과를 미리 계산해보는 "Dry Run"을 수행합니다.
- **함수 처리 설명**:
  1.  `file_path`의 현재 파일 내용을 읽습니다.
  2.  `ensureCorrectEdit` 함수를 호출하여, 모델이 제안한 `old_string`과 `new_string`에 있을 수 있는 사소한 오류를 다른 LLM을 통해 자동으로 보정합니다.
  3.  파일 내용에서 보정된 `old_string`이 몇 번 나타나는지(`occurrences`) 계산합니다.
  4.  **오류 검증**: 다음과 같은 다양한 예외 상황을 확인하고 오류를 반환합니다.
      - 수정할 파일이 존재하지 않는 경우.
      - `old_string`을 파일에서 찾지 못한 경우 (`occurrences === 0`).
      - 실제 발생 횟수(`occurrences`)와 모델이 예상한 횟수(`expected_replacements`)가 다른 경우.
      - `old_string`과 `new_string`이 동일하여 변경할 내용이 없는 경우.
  5.  오류가 없다면, 최종적으로 변경될 파일 내용(`newContent`)을 계산하여 반환합니다.

#### `shouldConfirmExecute()` 메서드

- **역할**: `execute()`가 호출되기 전, 사용자에게 실행 여부를 확인하고 `diff` 정보를 생성합니다.
- **함수 처리 설명**:
  1.  `calculateEdit()`를 호출하여 Dry Run 결과를 가져옵니다.
  2.  Dry Run 결과 오류가 있으면, 확인 절차를 진행하지 않고 `false`를 반환합니다.
  3.  오류가 없으면, 원본 내용과 `newContent` 간의 `diff`를 생성합니다.
  4.  UI가 사용자 확인 다이얼로그를 렌더링하는 데 필요한 정보(`ToolEditConfirmationDetails` 객체)를 반환합니다.

#### `execute()` 메서드

- **역할**: (사용자 확인 후) 실제 파일 수정 작업을 수행합니다.
- **함수 처리 설명**:
  1.  `calculateEdit()`를 다시 호출하여, 사용자 확인 과정에서 수정되었을 가능성까지 반영된 최종 변경 내용을 가져옵니다.
  2.  `calculateEdit` 결과에 오류가 있으면, 해당 오류를 담은 `ToolResult`를 즉시 반환합니다.
  3.  오류가 없으면, `FileSystemService.writeTextFile()`을 호출하여 계산된 `newContent`를 파일에 씁니다.
  4.  파일 수정 작업에 대한 원격 측정 데이터를 기록하고, 성공 메시지와 `FileDiff` 정보를 담은 `ToolResult`를 반환합니다.

## 4. 기타 참고사항

- **정밀한 제어**: 이 도구의 핵심은 `expected_replacements` 파라미터를 통해 모델이 자신이 의도한 만큼만 정확하게 수정하도록 강제하는 데 있습니다. 만약 모델이 1번의 교체를 예상했는데 실제 파일에서 `old_string`이 2번 발견되면, 의도치 않은 변경을 막기 위해 도구 실행은 실패합니다.
- **컨텍스트의 중요성**: 도구 설명(description)은 모델에게 `old_string`에 충분한 주변 컨텍스트(앞뒤 3줄 등)를 포함하도록 강력하게 요구합니다. 이는 교체할 부분을 유일하게 식별하여 실수를 줄이기 위함입니다.

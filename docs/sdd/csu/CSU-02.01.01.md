# CSU-02.01.01: 메인 에이전트

## 1. CSU 간단 설명

`agents/executor.ts`에 위치한 이 CSU는 자율적으로 작업을 수행하는 에이전트(subagent)의 핵심 실행 로직을 담당합니다. `AgentExecutor` 클래스는 주어진 목표(`AgentDefinition`)를 달성하기 위해 모델 호출과 도구(Tool) 사용을 반복하는 루프(loop)를 관장합니다.

이 에이전트는 사용자의 개입 없이 비대화형(non-interactive)으로 실행되며, '작업 단계'와 '추출 단계'의 2단계 접근 방식을 통해 체계적으로 결과를 도출합니다.

> _참고: SDD에 명시된 `agent.ts` 파일은 `executor.ts`로 리팩토링된 것으로 보입니다. 본 문서는 `executor.ts`를 기준으로 작성되었습니다._

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명        | 설명                                                                                                    |
| --------------- | ------------------------------------------------------------------------------------------------------- |
| `AgentExecutor` | 에이전트의 전체 실행 흐름(프롬프트 생성, 모델 호출, 도구 실행, 결과 처리)을 관장하는 메인 클래스입니다. |

### `AgentExecutor`의 주요 메서드

| 메서드명                   | 설명                                                                                                      |
| -------------------------- | --------------------------------------------------------------------------------------------------------- |
| `static create()`          | 에이전트 실행에 필요한 도구를 검증하고 `AgentExecutor`의 새 인스턴스를 생성하는 정적 팩토리 메서드입니다. |
| `run()`                    | 에이전트의 메인 실행 루프를 시작하고 최종 결과를 반환합니다.                                              |
| `callModel()`              | Gemini 모델을 호출하고, 스트리밍 응답에서 텍스트와 함수 호출(function call)을 추출합니다.                 |
| `processFunctionCalls()`   | 모델이 요청한 함수 호출을 실제로 실행하고, 그 결과를 모델에 다시 전달할 형식으로 가공합니다.              |
| `buildSystemPrompt()`      | 에이전트의 역할, 목표, 규칙 등을 정의하는 시스템 프롬프트를 생성합니다.                                   |
| `buildExtractionMessage()` | 모든 작업이 끝난 후, 최종 결과를 요약하고 추출하기 위한 마지막 프롬프트를 생성합니다.                     |

## 3. 각 함수에 대한 입출력 및 함수 처리 설명

### 3.1 `AgentExecutor.run()`

- **입력**:
  - `inputs`: `AgentInputs` (사용자가 에이전트 실행 시 제공하는 변수)
  - `signal`: `AbortSignal` (실행을 중단하기 위한 신호)
- **출력**: `Promise<OutputObject>` (에이전트의 최종 실행 결과와 종료 사유)
- **함수 처리 설명 (2-Phase 알고리즘)**:

  **1. 작업 단계 (Work Phase)**
  - `while (true)` 루프를 시작합니다.
  - **종료 조건 확인**: 최대 실행 턴(`max_turns`)이나 타임아웃(`max_time_minutes`)을 초과했는지, 또는 외부에서 `AbortSignal`을 보냈는지 확인하여 루프를 중단할지 결정합니다.
  - **모델 호출**: `callModel()`을 호출하여 현재까지의 대화 내용과 사용 가능한 도구 목록을 모델에 전달합니다.
  - **분기 처리**:
    - 모델이 **함수 호출을 요청**한 경우 (`functionCalls.length > 0`):
      - `processFunctionCalls()`를 호출하여 요청된 도구들을 실행합니다.
      - 도구 실행 결과를 다음 루프의 입력으로 사용하여 대화를 계속합니다.
    - 모델이 **함수 호출을 요청하지 않은** 경우 (`functionCalls.length === 0`):
      - 필요한 모든 정보를 수집했다고 판단하고, 작업 단계를 종료하기 위해 `break`로 루프를 탈출합니다.

  **2. 추출 단계 (Extraction Phase)**
  - 작업 단계가 정상적으로 완료되었을 경우에만 진행됩니다.
  - `buildExtractionMessage()`를 호출하여 "지금까지의 작업 내용을 바탕으로 최종 결과를 요약해줘"와 같은 요약 및 추출용 프롬프트를 생성합니다.
  - `callModel()`을 다시 호출하되, 이번에는 **도구를 제공하지 않고** 텍스트 응답만 받도록 합니다.
  - 모델이 생성한 최종 텍스트 응답을 `OutputObject`에 담아 반환합니다.

### 3.2 `AgentExecutor.callModel()`

- **입력**: `messages` (대화 내역), `tools` (사용 가능한 도구 목록), `signal` 등
- **출력**: `Promise<{ functionCalls, textResponse }>` (모델이 요청한 함수 호출 목록과 텍스트 응답)
- **함수 처리 설명**:
  - `GeminiChat.sendMessageStream()`을 사용하여 모델과 스트리밍 통신을 시작합니다.
  - `for await...of` 루프를 통해 응답 스트림을 실시간으로 처리합니다.
  - 스트림 조각(`chunk`)에서 `functionCalls`와 `text` 부분을 각각 추출하여 수집합니다.
  - 모델의 "생각" 과정을 담은 `thought` 부분을 파싱하여 `onActivity` 콜백으로 전달함으로써, 외부에서 에이전트의 활동을 모니터링할 수 있게 합니다.

### 3.3 `AgentExecutor.processFunctionCalls()`

- **입력**: `functionCalls` (모델이 요청한 함수 호출 목록)
- **출력**: `Promise<Content[]>` (도구 실행 결과를 담은 `Content` 객체 배열)
- **함수 처리 설명**:
  - `functionCalls` 배열을 순회하며 각 함수 호출을 처리합니다.
  - `executeToolCall()` 함수를 사용하여 실제 도구 로직을 실행합니다. (`CSU-02.02.01`의 `ToolRegistry`를 통해 도구를 찾습니다.)
  - 각 도구의 실행 결과를 `responseParts` 배열에 수집합니다.
  - 모든 실행 결과를 `[{ role: 'user', parts: toolResponseParts }]` 형태의 단일 `Content` 객체로 만들어 반환합니다. 이 객체는 다음 `callModel`의 입력으로 사용됩니다.

## 4. 기타 참고사항

- 이 CSU는 `gemini-cli` 내에서 자율적으로 특정 목표를 해결해야 하는 복잡한 작업(예: 코드베이스 분석 후 보고서 작성)을 수행하는 데 사용될 수 있습니다.
- 에이전트가 사용할 수 있는 도구는 `AgentDefinition`에 명시적으로 정의되며, `validateTools` 메서드를 통해 사용자 확인이 필요 없는 안전한 도구만 사용하도록 강제됩니다.

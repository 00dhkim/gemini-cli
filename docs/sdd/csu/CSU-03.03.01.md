# CSU-03.03.01: 웹 페이지 Fetch

## 1. CSU 간단 설명

`tools/web-fetch.ts`에 위치한 이 CSU는 모델(LLM)이 주어진 URL의 웹 페이지 내용을 가져와 처리할 수 있도록 하는 `web_fetch` 도구를 구현합니다. 이 도구는 단순한 HTML 다운로더가 아니라, Gemini API의 내장된 URL Fetch 기능을 우선적으로 활용하는 지능적인 접근 방식을 사용합니다.

또한, API가 직접 접근할 수 없는 `localhost`나 사설 IP 주소에 대해서는, CLI 환경에서 직접 콘텐츠를 가져와 모델에게 전달하는 대체(Fallback) 메커니즘을 갖추고 있어 범용성을 높였습니다. 모델이 생성한 답변에 출처(Source)와 인용(Citation) 정보를 자동으로 추가하는 기능도 포함합니다.

## 2. CSU를 구성하는 변수와 함수 목록

### 주요 클래스

| 클래스명                 | 설명                                                                           |
| ------------------------ | ------------------------------------------------------------------------------ |
| `WebFetchTool`           | `web_fetch` 도구의 정의(이름, 설명, 파라미터 스키마)를 담당하는 클래스입니다.  |
| `WebFetchToolInvocation` | `web_fetch` 도구가 실제로 호출되었을 때, 그 실행 로직을 담당하는 클래스입니다. |

## 3. 각 클래스에 대한 입출력 및 함수 처리 설명

### 3.1 `WebFetchTool` 클래스

- **역할**: 모델에게 `web_fetch` 도구의 사용법을 알려주는 명세(specification)를 정의합니다.
- **주요 로직**:
  - **`constructor()`**: 도구의 이름(`web_fetch`), 설명, 그리고 파라미터의 JSON 스키마를 설정합니다. 이 도구는 `prompt`라는 단일 파라미터만 받으며, 이 파라미터 안에 URL과 "요약해줘", "키포인트를 추출해줘"와 같은 지시사항을 함께 담도록 요구합니다.
  - **`validateToolParamValues(params)`**: 모델이 전달한 `prompt` 파라미터가 비어있지 않고, `http://` 또는 `https://`로 시작하는 유효한 URL을 최소 하나 이상 포함하고 있는지 검증합니다.
  - **`createInvocation(params)`**: 파라미터 유효성 검증이 끝나면, 실제 실행 로직을 담고 있는 `WebFetchToolInvocation` 인스턴스를 생성하여 반환합니다.

### 3.2 `WebFetchToolInvocation` 클래스

- **역할**: `web_fetch` 도구의 한 번의 호출에 대한 실제 실행을 담당하며, 기본 전략과 대체 전략을 상황에 맞게 선택하여 실행합니다.

#### `execute()` 메서드

- **입력**: 없음 (필요한 파라미터는 생성자에서 `this.params`로 전달받음)
- **출력**: `Promise<ToolResult>` (웹 페이지 처리 결과를 포함한 객체)
- **함수 처리 설명 (이중 전략 아키텍처)**:

  **1. 기본 전략: Gemini API의 `urlContext` 활용**
  - **조건**: `prompt`에 포함된 URL이 사설 IP가 아닐 경우 이 전략을 사용합니다.
  - **실행**: `geminiClient.generateContent`를 호출하되, `tools` 옵션에 `{ urlContext: {} }`를 포함하여 전송합니다. 이 옵션은 Gemini API가 직접 URL의 콘텐츠를 가져와서 사용자의 지시사항을 처리하도록 하는 신호입니다.
  - **결과 처리**: API 응답에는 모델이 생성한 텍스트뿐만 아니라, `groundingMetadata`(출처 및 인용 정보)가 포함될 수 있습니다. 이 메타데이터를 파싱하여, 응답 텍스트의 적절한 위치에 인용 번호(`[1]`, `[2]`)를 삽입하고, 텍스트 끝에 출처 목록을 추가하여 최종 `llmContent`를 생성합니다.
  - **실패 시**: 만약 API가 URL 콘텐츠를 가져오는 데 실패하면, 아래의 대체 전략으로 넘어갑니다.

  **2. 대체 전략: CLI 직접 Fetch (`executeFallback`)**
  - **조건**: URL이 `localhost`와 같은 사설 IP이거나, 기본 전략이 실패했을 경우 이 전략을 사용합니다.
  - **실행**:
    a. `fetchWithTimeout`을 사용하여 CLI 환경에서 직접 URL의 HTML 콘텐츠를 가져옵니다.
    b. `html-to-text` 라이브러리를 사용하여 HTML 태그를 제거하고 순수 텍스트만 추출합니다.
    c. 모델에게 전달할 새로운 프롬프트를 생성합니다. (예: "사용자가 원래 이 URL에 대해 요약을 요청했지만, 내가 대신 가져온 내용은 다음과 같아. 이 내용을 바탕으로 요약해줘.")
    d. 이 새로운 프롬프트를 `geminiClient.generateContent`로 전송하여 최종 답변을 얻습니다.

## 4. 기타 참고사항

- **GitHub URL 처리**: 대체 전략 실행 시, GitHub의 파일 보기 페이지 주소(`.../blob/...`)를 실제 원시 파일 주소(`raw.githubusercontent.com/...`)로 자동 변환하여, 코드 파일의 내용을 정확하게 가져오는 기능이 포함되어 있습니다.
- **사용자 확인**: 다른 민감한 도구와 마찬가지로, `shouldConfirmExecute` 메서드를 통해 웹 페이지를 실제로 가져오기 전에 사용자에게 URL을 보여주고 실행 여부를 확인받는 절차를 거칩니다.

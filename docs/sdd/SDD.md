# 소프트웨어 설계 기술서 (SDD): gemini-cli

## 1. 개요

본 문서는 `gemini-cli` 프로젝트의 소프트웨어 설계를 기술하는 것을 목적으로 한다. `gemini-cli`는 사용자가 터미널 환경에서 Gemini 모델의 능력을 활용할 수 있도록 지원하는 오픈소스 AI 에이전트이다.

본 설계서는 국방 소프트웨어 개발 표준에 따라 소프트웨어를 컴퓨터 소프트웨어 구성항목(CSCI), 컴퓨터 소프트웨어 컴포넌트(CSC), 컴퓨터 소프트웨어 단위(CSU)의 계층적 구조로 식별하고, 각 구성요소의 역할과 인터페이스를 명세한다.

## 2. 소프트웨어 구조 (CSCI)

`gemini-cli` 소프트웨어는 주요 기능과 역할에 따라 3개의 CSCI로 구성된다.

| 식별자      | CSCI 이름                          | 설명                                                                                                                           | 주요 소스 경로             |
| :---------- | :--------------------------------- | :----------------------------------------------------------------------------------------------------------------------------- | :------------------------- |
| **CSCI-01** | **Gemini CLI (사용자 인터페이스)** | 사용자와의 모든 상호작용을 담당하는 최상위 프론트엔드 컴포넌트. 명령어 입력, 결과 출력, 설정 등 전체적인 터미널 UX를 관리한다. | `packages/cli`             |
| **CSCI-02** | **Gemini Core (에이전트 엔진)**    | AI 추론을 오케스트레이션하는 핵심 백엔드 컴포넌트. Gemini 모델 통신, 프롬프트 구성, 도구(Tool) 실행을 총괄한다.                | `packages/core`            |
| **CSCI-03** | **내장 도구 (Built-in Tools)**     | 에이전트가 로컬 환경과 상호작용하거나 정보를 얻기 위해 사용하는 기능의 집합.                                                   | `packages/core/src/tools/` |

## 3. CSCI 간 인터페이스

CSCI 간의 명확한 인터페이스는 시스템의 모듈성과 확장성을 보장한다. 주요 인터페이스 목록은 다음과 같다.

| 식별자     | 원천 CSCI | 목적지 CSCI           | 통신 방법              | 프로토콜/데이터                                        | 설명                                                                          |
| :--------- | :-------- | :-------------------- | :--------------------- | :----------------------------------------------------- | :---------------------------------------------------------------------------- |
| **INT-01** | CSCI-01   | CSCI-02               | 함수 호출 (In-Process) | TypeScript 함수 시그니처 (사용자 입력 객체, 세션 상태) | 사용자가 입력한 프롬프트를 Core 엔진에 전달하여 에이전트 실행을 시작한다.     |
| **INT-02** | CSCI-02   | CSCI-03               | 함수 호출 (In-Process) | `Tool.execute(input)` (도구별 입력 객체)               | 모델의 판단에 따라 특정 도구(CSU)의 실행을 요청한다.                          |
| **INT-03** | CSCI-02   | 외부 (Gemini API)     | HTTPS                  | REST API (JSON)                                        | 사용자 프롬프트와 컨텍스트를 Gemini 모델에 전송하고 응답을 수신한다.          |
| **INT-04** | CSCI-02   | 외부 (OTLP Collector) | gRPC / HTTP            | OTLP                                                   | 에이전트의 동작 로그, 성능 지표 등 원격 측정 데이터를 외부 수집기로 전송한다. |
| **INT-05** | CSCI-03   | 외부 (OS/Web)         | 시스템 콜 / HTTPS      | Shell, HTTP/S                                          | 파일 시스템, 셸, 웹 등 외부 환경과 직접 상호작용한다.                         |

## 4. 상세 설계 (CSC / CSU)

### 4.1 CSCI-01: Gemini CLI (사용자 인터페이스)

| CSC ID        | CSC 이름                | 설명                                                                                                     |
| :------------ | :---------------------- | :------------------------------------------------------------------------------------------------------- |
| **CSC-01.01** | **명령어 및 입력 처리** | 사용자가 입력하는 명령어와 플래그를 파싱하고, 대화 내역을 관리하며, 최상위 애플리케이션 로직을 담당한다. |
| **CSC-01.02** | **UI 렌더링**           | React와 Ink 라이브러리를 사용하여 터미널에 표시되는 모든 UI 컴포넌트를 렌더링한다.                       |
| **CSC-01.03** | **설정 및 인증 관리**   | 사용자의 인증 정보, `settings.json` 파일에 정의된 설정 값, 테마 등을 관리하고 적용한다.                  |

#### CSC-01.01: 명령어 및 입력 처리

| CSU ID                                    | CSU 이름               | 설명                                                              | 소스 경로                                  |
| :---------------------------------------- | :--------------------- | :---------------------------------------------------------------- | :----------------------------------------- |
| [**CSU-01.01.01**](./csu/CSU-01.01.01.md) | **메인 애플리케이션**  | CLI 애플리케이션의 메인 루프 및 최상위 상태를 관리하는 주 진입점. | `packages/cli/src/gemini.tsx`              |
| [**CSU-01.01.02**](./csu/CSU-01.01.02.md) | **비대화형 CLI 처리**  | `-p` 플래그 등 비대화형 모드의 명령어 실행을 처리한다.            | `packages/cli/src/nonInteractiveCli.ts`    |
| [**CSU-01.01.03**](./csu/CSU-01.01.03.md) | **MCP 명령어 핸들러**  | `/mcp` 명령어와 관련된 로직을 처리한다.                           | `packages/cli/src/commands/mcp.ts`         |
| [**CSU-01.01.04**](./csu/CSU-01.01.04.md) | **확장 명령어 핸들러** | 사용자 정의 확장 명령어 로딩 및 실행을 처리한다.                  | `packages/cli/src/commands/extensions.tsx` |

#### CSC-01.02: UI 렌더링

| CSU ID                                    | CSU 이름                | 설명                                                                         | 소스 경로                         |
| :---------------------------------------- | :---------------------- | :--------------------------------------------------------------------------- | :-------------------------------- |
| [**CSU-01.02.01**](./csu/CSU-01.02.01.md) | **UI 레이아웃**         | 애플리케이션의 전체적인 화면 구조(헤더, 바디, 푸터 등)를 정의한다.           | `packages/cli/src/ui/layouts/`    |
| [**CSU-01.02.02**](./csu/CSU-01.02.02.md) | **UI 컴포넌트**         | 메시지 버블, 입력창, 상태 바 등 개별 UI 요소를 정의한다.                     | `packages/cli/src/ui/components/` |
| [**CSU-01.02.03**](./csu/CSU-01.02.03.md) | **UI 상태 관리(Hooks)** | React Hooks를 사용하여 UI의 동적 상태(메시지 목록, 로딩 상태 등)를 관리한다. | `packages/cli/src/ui/hooks/`      |

#### CSC-01.03: 설정 및 인증 관리

| CSU ID                                    | CSU 이름           | 설명                                                                  | 소스 경로                     |
| :---------------------------------------- | :----------------- | :-------------------------------------------------------------------- | :---------------------------- |
| [**CSU-01.03.01**](./csu/CSU-01.03.01.md) | **인증 흐름 관리** | OAuth 로그인, API 키 입력 등 사용자의 인증 과정을 처리하는 UI와 로직. | `packages/cli/src/ui/auth/`   |
| [**CSU-01.03.02**](./csu/CSU-01.03.02.md) | **설정 파일 관리** | `settings.json` 파일의 로딩, 파싱, 적용을 담당한다.                   | `packages/cli/src/config/`    |
| [**CSU-01.03.03**](./csu/CSU-01.03.03.md) | **테마 관리**      | 사용자가 선택한 테마에 따라 UI의 색상과 스타일을 적용한다.            | `packages/cli/src/ui/themes/` |

### 4.2 CSCI-02: Gemini Core (에이전트 엔진)

| CSC ID        | CSC 이름                        | 설명                                                                                                                   |
| :------------ | :------------------------------ | :--------------------------------------------------------------------------------------------------------------------- |
| **CSC-02.01** | **에이전트 오케스트레이션**     | 대화의 메인 루프를 관리하며, 사용자 입력과 컨텍스트를 조합하여 Gemini 모델에 보낼 프롬프트를 구성하고 응답을 처리한다. |
| **CSC-02.02** | **도구 관리 및 실행**           | 사용 가능한 모든 도구(Tool)를 등록하고, 모델의 도구 사용 요청에 따라 적절한 도구를 찾아 실행한다.                      |
| **CSC-02.03** | **외부 서비스 연동**            | Google Gemini API, 원격 측정(Telemetry)을 위한 OTLP 수집기 등 외부 서비스와의 통신을 담당한다.                         |
| **CSC-02.04** | **MCP(Model Context Protocol)** | 외부 확장 서버(MCP 서버)와의 통신을 관리하여, 기본 도구 외에 추가적인 기능을 연동할 수 있도록 지원한다.                |

#### CSC-02.01: 에이전트 오케스트레이션

| CSU ID                                    | CSU 이름                | 설명                                                                                       | 소스 경로                              |
| :---------------------------------------- | :---------------------- | :----------------------------------------------------------------------------------------- | :------------------------------------- |
| [**CSU-02.01.01**](./csu/CSU-02.01.01.md) | **메인 에이전트**       | 자율 에이전트의 전체 실행 흐름(프롬프트 생성, 모델 호출, 도구 실행, 결과 처리)을 관장한다. | `packages/core/src/agents/executor.ts` |
| [**CSU-02.01.02**](./csu/CSU-02.01.02.md) | **프롬프트 레지스트리** | MCP 서버 등 외부에서 제공하는 프롬프트 템플릿을 등록하고 관리하는 저장소.                  | `packages/core/src/prompts/`           |
| [**CSU-02.01.03**](./csu/CSU-02.01.03.md) | **모델 라우팅 전략**    | 사용자의 질문 의도에 따라 사용할 Gemini 모델(예: Flash, Pro)을 동적으로 결정하는 로직.     | `packages/core/src/routing/`           |

#### CSC-02.02: 도구 관리 및 실행

| CSU ID                                    | CSU 이름             | 설명                                                                                                     | 소스 경로                                  |
| :---------------------------------------- | :------------------- | :------------------------------------------------------------------------------------------------------- | :----------------------------------------- |
| [**CSU-02.02.01**](./csu/CSU-02.02.01.md) | **도구 레지스트리**  | 시스템에서 사용 가능한 모든 도구(CSCI-03)를 등록하고 관리하는 저장소.                                    | `packages/core/src/tools/tool-registry.ts` |
| [**CSU-02.02.02**](./csu/CSU-02.02.02.md) | **사용자 확인 버스** | 파일 쓰기, 셸 명령어 실행 등 민감한 도구 실행 전 사용자에게 확인을 요청하고 승인을 처리하는 메시지 버스. | `packages/core/src/confirmation-bus/`      |

#### CSC-02.03: 외부 서비스 연동

| CSU ID                                    | CSU 이름              | 설명                                                                                | 소스 경로                              |
| :---------------------------------------- | :-------------------- | :---------------------------------------------------------------------------------- | :------------------------------------- |
| [**CSU-02.03.01**](./csu/CSU-02.03.01.md) | **Gemini API 서비스** | INT-03 인터페이스를 통해 Gemini API와 직접 통신하는 고수준 채팅 클라이언트.         | `packages/core/src/core/geminiChat.ts` |
| [**CSU-02.03.02**](./csu/CSU-02.03.02.md) | **원격 측정 서비스**  | INT-04 인터페이스를 통해 에이전트의 사용 데이터를 OTLP 표준에 맞춰 외부로 전송한다. | `packages/core/src/telemetry/`         |

#### CSC-02.04: MCP(Model Context Protocol)

| CSU ID                                    | CSU 이름            | 설명                                                                                | 소스 경로                               |
| :---------------------------------------- | :------------------ | :---------------------------------------------------------------------------------- | :-------------------------------------- |
| [**CSU-02.04.01**](./csu/CSU-02.04.01.md) | **MCP 클라이언트**  | MCP 서버에 연결하고, 서버가 제공하는 도구 목록을 가져와 도구 레지스트리에 등록한다. | `packages/core/src/tools/mcp-client.ts` |
| [**CSU-02.04.02**](./csu/CSU-02.04.02.md) | **MCP 토큰 저장소** | MCP 서버 인증에 사용되는 토큰을 안전하게 관리하고 저장한다.                         | `packages/core/src/mcp/token-storage/`  |

### 4.3 CSCI-03: 내장 도구 (Built-in Tools)

| CSC ID        | CSC 이름                | 설명                                                                      |
| :------------ | :---------------------- | :------------------------------------------------------------------------ |
| **CSC-03.01** | **파일 시스템 도구**    | 로컬 파일 시스템을 읽고, 쓰고, 검색하는 기능 모음.                        |
| **CSC-03.02** | **셸 및 검색 도구**     | 로컬 셸 명령어를 실행하거나 파일 내용에서 특정 패턴을 검색하는 기능 모음. |
| **CSC-03.03** | **웹 도구**             | 웹 페이지 내용을 가져오거나 Google 검색을 수행하는 기능 모음.             |
| **CSC-03.04** | **메모리 및 상태 도구** | 대화 중 중요한 정보를 기억하는 등 에이전트의 상태를 관리하는 기능.        |

#### CSC-03.01: 파일 시스템 도구

| CSU ID                                    | CSU 이름                 | 설명                                                 | 소스 경로                               |
| :---------------------------------------- | :----------------------- | :--------------------------------------------------- | :-------------------------------------- |
| [**CSU-03.01.01**](./csu/CSU-03.01.01.md) | **디렉토리 리스팅**      | 지정된 경로의 파일 및 하위 디렉토리 목록을 반환한다. | `packages/core/src/tools/ls.ts`         |
| [**CSU-03.01.02**](./csu/CSU-03.01.02.md) | **파일 읽기**            | 지정된 파일의 내용을 읽어 반환한다.                  | `packages/core/src/tools/read-file.ts`  |
| [**CSU-03.01.03**](./csu/CSU-03.01.03.md) | **파일 쓰기**            | 지정된 파일에 내용을 쓴다.                           | `packages/core/src/tools/write-file.ts` |
| [**CSU-03.01.04**](./csu/CSU-03.01.04.md) | **파일 패턴 검색(Glob)** | Glob 패턴과 일치하는 파일 경로 목록을 검색한다.      | `packages/core/src/tools/glob.ts`       |
| [**CSU-03.01.05**](./csu/CSU-03.01.05.md) | **파일 수정(Edit)**      | 파일의 특정 내용을 다른 내용으로 교체한다.           | `packages/core/src/tools/edit.ts`       |

#### CSC-03.02: 셸 및 검색 도구

| CSU ID                                    | CSU 이름            | 설명                                                    | 소스 경로                          |
| :---------------------------------------- | :------------------ | :------------------------------------------------------ | :--------------------------------- |
| [**CSU-03.02.01**](./csu/CSU-03.02.01.md) | **셸 명령어 실행**  | 운영체제의 셸을 통해 명령어를 실행하고 결과를 반환한다. | `packages/core/src/tools/shell.ts` |
| [**CSU-03.02.02**](./csu/CSU-03.02.02.md) | **내용 검색(Grep)** | 파일 내용에서 정규식 패턴과 일치하는 라인을 검색한다.   | `packages/core/src/tools/grep.ts`  |

#### CSC-03.03: 웹 도구

| CSU ID                                    | CSU 이름            | 설명                                                  | 소스 경로                               |
| :---------------------------------------- | :------------------ | :---------------------------------------------------- | :-------------------------------------- |
| [**CSU-03.03.01**](./csu/CSU-03.03.01.md) | **웹 페이지 Fetch** | 주어진 URL의 웹 페이지 HTML 내용을 가져온다.          | `packages/core/src/tools/web-fetch.ts`  |
| [**CSU-03.03.02**](./csu/CSU-03.03.02.md) | **Google 웹 검색**  | 주어진 쿼리로 Google 검색을 수행하고 결과를 반환한다. | `packages/core/src/tools/web-search.ts` |

#### CSC-03.04: 메모리 및 상태 도구

| CSU ID                                    | CSU 이름              | 설명                                                   | 소스 경로                               |
| :---------------------------------------- | :-------------------- | :----------------------------------------------------- | :-------------------------------------- |
| [**CSU-03.04.01**](./csu/CSU-03.04.01.md) | **정보 저장(Memory)** | 사용자가 요청한 특정 정보를 장기 기억 공간에 저장한다. | `packages/core/src/tools/memoryTool.ts` |
